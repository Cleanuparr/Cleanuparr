<app-page-header
  title="Malware Blocker"
  subtitle="Protect against malicious files in downloads"
/>

@if (loadError()) {
  <app-empty-state
    icon="tablerPlugConnectedX"
    heading="Could not connect to server"
    description="Failed to load settings. Please check that the server is running and try again."
  >
    <app-button variant="primary" size="sm" (clicked)="retry()">
      Retry
    </app-button>
  </app-empty-state>
} @else {
<div class="settings-form">
  <app-card header="General">
    <div class="form-stack">
      <app-toggle label="Enabled" [(checked)]="enabled"
        hint="When enabled, the Malware blocker will run according to the schedule"
        helpKey="malware-blocker:enabled" />
      @if (enabled()) {
        <app-toggle label="Delete Known Malware" [(checked)]="deleteKnownMalware"
          hint="When enabled, downloads matching known malware patterns will be deleted"
          helpKey="malware-blocker:deleteKnownMalware" />
        <app-toggle label="Ignore Private Torrents" [(checked)]="ignorePrivate"
          hint="When enabled, private torrents will not be processed"
          helpKey="malware-blocker:ignorePrivate" />
        <app-toggle label="Delete Private from Client" [(checked)]="deletePrivate"
          [disabled]="deletePrivateDisabled()"
          hint="Disable this if you want to keep private torrents in the download client even if they are removed from the arrs"
          helpKey="malware-blocker:deletePrivate" />

        <div class="form-divider"></div>

        <app-toggle label="Advanced Scheduling" [(checked)]="useAdvancedScheduling"
          hint="Choose between basic scheduling or advanced cron expression"
          helpKey="malware-blocker:useAdvancedScheduling" />
        @if (useAdvancedScheduling()) {
          <app-input label="Cron Expression" placeholder="0 0/5 * ? * * *" [(value)]="cronExpression"
            hint="Enter a valid Quartz cron expression (e.g., &quot;0 0/5 * ? * * *&quot; runs every 5 minutes)"
            [error]="cronError()"
            helpKey="malware-blocker:cronExpression" />
        } @else {
          <div class="form-row">
            <app-select label="Schedule Unit" [options]="scheduleUnitOptions" [(value)]="scheduleUnit"
              hint="Choose the time unit for the schedule"
              helpKey="malware-blocker:scheduleUnit" />
            <app-select label="Every" [options]="scheduleIntervalOptions()" [(value)]="scheduleEvery"
              hint="How often the job should run"
              [error]="scheduleEveryError()"
              helpKey="malware-blocker:scheduleEvery" />
          </div>
        }

        <div class="form-divider"></div>

        <app-chip-input
          label="Ignored Downloads"
          placeholder="Add download pattern..."
          hint="Downloads matching these patterns will be ignored (e.g. hash, tag, category, label, tracker)"
          [(items)]="ignoredDownloads"
          helpKey="malware-blocker:ignoredDownloads"
        />
      }
    </div>
  </app-card>

  @if (enabled()) {
    <app-accordion header="Arr Blocklists" subtitle="Per-application blocklist configuration" [(expanded)]="arrExpanded">
      @for (name of arrNames; track name) {
        <div class="arr-blocklist">
          <h4 class="arr-blocklist__title">{{ capitalize(name) }}</h4>
          <div class="form-stack">
            <app-toggle
              label="Enabled"
              [checked]="arrBlocklists()[name].enabled"
              (checkedChange)="updateArrBlocklist(name, 'enabled', $event)"
              [hint]="'When enabled, the ' + capitalize(name) + ' blocklist will be used for content filtering'"
            />
            @if (arrBlocklists()[name].enabled) {
              <app-input
                label="Blocklist Path"
                [value]="arrBlocklists()[name].blocklistPath"
                (valueChange)="updateArrBlocklist(name, 'blocklistPath', $event)"
                placeholder="Local file path or URL"
                hint="Path to the blocklist file or URL"
                [error]="blocklistPathError(name)"
              />
              <app-select
                label="Blocklist Type"
                [options]="blocklistTypeOptions"
                [value]="arrBlocklists()[name].blocklistType"
                (valueChange)="updateArrBlocklist(name, 'blocklistType', $event)"
                hint="Type of blocklist: Blacklist (block matches) or Whitelist (only allow matches)"
              />
            }
          </div>
        </div>
      }
    </app-accordion>

  }

  <div class="form-actions">
    <app-button variant="primary" [loading]="saving()" [disabled]="saving() || saved() || hasErrors()" (clicked)="save()">
      {{ saved() ? 'Saved!' : 'Save Settings' }}
    </app-button>
  </div>
</div>
}
