<app-page-header
  title="Events"
  subtitle="System events and notifications"
/>

<!-- Toolbar -->
<div class="toolbar">
  <div class="toolbar__filters">
    <app-select
      placeholder="All Severities"
      [options]="severityOptions()"
      [(value)]="selectedSeverity"
      (valueChange)="onFilterChange()"
    />
    <app-select
      placeholder="All Types"
      [options]="typeOptions()"
      [(value)]="selectedType"
      (valueChange)="onFilterChange()"
    />
    <app-input
      placeholder="Search events..."
      type="search"
      [(value)]="searchQuery"
      (blurred)="onFilterChange()"
    />
  </div>
  <div class="toolbar__actions">
    <app-button variant="ghost" size="sm" (clicked)="refresh()">
      Refresh
    </app-button>
  </div>
</div>

<!-- Events Count -->
<div class="event-count">
  {{ totalRecords() }} events
</div>

<!-- Events List -->
<app-card [noPadding]="true">
  <div class="events-list">
    @for (event of events(); track event.id) {
      <div
        class="event-row"
        [class.event-row--expanded]="expandedId() === event.id"
        (click)="toggleExpand(event.id)"
      >
        <div class="event-row__main">
          <div class="event-row__marker" [class]="'event-row__marker--' + eventSeverity(event.severity)"></div>
          <div class="event-row__body">
            <div class="event-row__top">
              <app-badge [severity]="eventSeverity(event.severity)" size="sm">
                {{ formatEventType(event.eventType) }}
              </app-badge>
              @if (event.trackingId) {
                <span class="event-row__tracking">{{ event.trackingId }}</span>
              }
              <span class="event-row__time">{{ event.timestamp | date:'short' }}</span>
            </div>
            <p class="event-row__message">{{ truncate(event.message) }}</p>
          </div>
          <button class="event-row__copy" (click)="copyEvent(event); $event.stopPropagation()" title="Copy">
            <ng-icon name="tablerFileText" />
          </button>
        </div>

        @if (expandedId() === event.id) {
          <div class="event-row__details">
            <div class="event-row__detail">
              <span class="event-row__detail-label">Full Message</span>
              <span class="event-row__detail-value">{{ event.message }}</span>
            </div>
            @if (event.trackingId) {
              <div class="event-row__detail">
                <span class="event-row__detail-label">Tracking ID</span>
                <span class="event-row__detail-value">{{ event.trackingId }}</span>
              </div>
            }
            @if (parseEventData(event.data); as data) {
              <div class="event-row__detail">
                <span class="event-row__detail-label">Event Data</span>
                <div class="event-row__data">
                  @for (key of objectKeys(data); track key) {
                    <div class="event-row__data-item">
                      <span class="event-row__data-key">{{ key }}</span>
                      <span class="event-row__data-value">{{ data[key] }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    } @empty {
      <app-empty-state
        icon="tablerBell"
        heading="No events"
        description="No events match your current filters."
      />
    }
  </div>
</app-card>

<!-- Pagination -->
@if (totalRecords() > pageSize()) {
  <app-paginator
    [totalRecords]="totalRecords()"
    [pageSize]="pageSize()"
    [currentPage]="currentPage()"
    (pageChange)="onPageChange($event)"
  />
}
