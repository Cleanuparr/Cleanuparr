<div class="settings-container">
  <div class="flex align-items-center justify-content-between mb-4">
    <h1>Queue Cleaner</h1>
  </div>

  <p-card styleClass="settings-card h-full">
    <ng-template pTemplate="header">
      <div class="flex align-items-center justify-content-between p-3 border-bottom-1 surface-border">
        <div class="header-title-container">
          <h2 class="card-title m-0">Queue Cleaner Configuration</h2>
          <span class="card-subtitle">Configure automatic arr queue cleanup</span>
        </div>
      </div>
  </ng-template>

  <div class="card-content">
    <!-- Loading/Error State Component -->
    <app-loading-error-state
      *ngIf="queueCleanerLoading() || queueCleanerLoadError()"
      [loading]="queueCleanerLoading()"
      [error]="queueCleanerLoadError()"
      loadingMessage="Loading settings..."
      errorMessage="Could not connect to server"
    ></app-loading-error-state>

    <!-- Form Content - only shown when not loading and no error -->
    <form *ngIf="!queueCleanerLoading() && !queueCleanerLoadError()" [formGroup]="queueCleanerForm" class="p-fluid">
      <!-- Main Settings -->
      <div class="field-row">
        <label class="field-label">
          <i class="pi pi-question-circle field-info-icon" 
             (click)="openFieldDocs('enabled')" 
             title="Click for documentation"></i>
          Enable Queue Cleaner
        </label>
        <div class="field-input">
          <p-checkbox formControlName="enabled" [binary]="true" inputId="qcEnabled"></p-checkbox>
          <small class="form-helper-text">When enabled, the queue cleaner will run according to the schedule</small>
        </div>
      </div>

      <!-- Scheduling Mode Toggle -->
      <div class="field-row">
        <label class="field-label">
          <i class="pi pi-question-circle field-info-icon" 
             (click)="openFieldDocs('useAdvancedScheduling')" 
             title="Click for documentation"></i>
          Scheduling Mode
        </label>
        <div class="field-input">
          <p-selectButton
            formControlName="useAdvancedScheduling"
            [options]="scheduleModeOptions"
            optionLabel="label"
            optionValue="value"
            [allowEmpty]="false"
            [multiple]="false"
          >
          </p-selectButton>
          <small class="form-helper-text">Choose between basic scheduling or advanced cron expression</small>
        </div>
      </div>

      <!-- Basic Schedule Controls - shown when useAdvancedScheduling is false -->
      <div class="field-row" formGroupName="jobSchedule" *ngIf="!queueCleanerForm.get('useAdvancedScheduling')?.value">
        <label class="field-label">
          Run Schedule
        </label>
        <div>
          <div class="field-input schedule-input flex flex-wrap">
            <span class="schedule-label">Every</span>
            <p-select 
              formControlName="every"
              [options]="getScheduleValueOptions()"
              optionLabel="label"
              optionValue="value"
              placeholder="Select interval"
            ></p-select>

            <p-selectButton
              formControlName="type"
              [options]="scheduleUnitOptions"
              optionLabel="label"
              optionValue="value"
              [allowEmpty]="false"
              [multiple]="false"
            >
            </p-selectButton>
          </div>
          <small *ngIf="hasNestedError('jobSchedule', 'every', 'required')" class="p-error">This field is required</small>
          <small class="form-helper-text">How often the queue cleaner should run</small>
        </div>
      </div>

      <!-- Advanced Schedule Controls - shown when useAdvancedScheduling is true -->
      <div class="field-row" *ngIf="queueCleanerForm.get('useAdvancedScheduling')?.value">
        <label class="field-label">
          <i class="pi pi-question-circle field-info-icon" 
             (click)="openFieldDocs('cronExpression')" 
             title="Click for documentation"></i>
          Cron Expression
        </label>
        <div>
          <div class="field-input">
            <input type="text" pInputText formControlName="cronExpression" placeholder="0 0/5 * ? * * *" />
          </div>
          <small *ngIf="hasMainFormError('cronExpression', 'required')" class="p-error">Cron expression is required</small>
          <small class="form-helper-text">Enter a valid Quartz cron expression (e.g., "0 0/5 * ? * * *" runs every 5 minutes)</small>
        </div>
      </div>

      <!-- Detailed Settings in Accordion -->
      <p-accordion [multiple]="false" [value]="activeAccordionIndices" styleClass="mt-3">
        <!-- Failed Import Settings -->
        <p-accordion-panel [disabled]="!queueCleanerForm.get('enabled')?.value" [value]="0">
          <p-accordion-header>
            <ng-template #toggleicon let-active="active">
              @if (active) {
                <i class="pi pi-chevron-up"></i>
              } @else {
                <i class="pi pi-chevron-down"></i>
              }
            </ng-template>
            Failed Import Settings
          </p-accordion-header>
          <p-accordion-content>
            <div class="field-row" formGroupName="failedImport">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('failedImport.maxStrikes')" 
                   title="Click for documentation"></i>
                Max Strikes
              </label>
              <div>
                <div class="field-input">
                  <p-inputNumber
                    formControlName="maxStrikes"
                    [showButtons]="true"
                    [min]="0"
                    buttonLayout="horizontal"
                  >
                  </p-inputNumber>
                </div>
                <small *ngIf="hasNestedError('failedImport', 'maxStrikes', 'required')" class="p-error">This field is required</small>
                <small *ngIf="hasNestedError('failedImport', 'maxStrikes', 'max')" class="p-error">Value cannot exceed 5000</small>
                <small class="form-helper-text"
                  >Number of strikes before action is taken (0 to disable, min 3 to enable)</small
                >
              </div>
            </div>

            <div class="field-row" formGroupName="failedImport">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('failedImport.ignorePrivate')" 
                   title="Click for documentation"></i>
                Ignore Private
              </label>
              <div class="field-input">
                <p-checkbox formControlName="ignorePrivate" [binary]="true"></p-checkbox>
                <small class="form-helper-text">When enabled, private torrents will not be checked for being failed imports</small>
              </div>
            </div>

            <div class="field-row" formGroupName="failedImport">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('failedImport.deletePrivate')" 
                   title="Click for documentation"></i>
                Delete Private
              </label>
              <div class="field-input">
                <p-checkbox formControlName="deletePrivate" [binary]="true"></p-checkbox>
                <small class="form-helper-text">Disable this if you want to keep private torrents in the download client even if they are removed from the arrs</small>
              </div>
            </div>

            <div class="field-row" formGroupName="failedImport">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('failedImport.ignoredPatterns')" 
                   title="Click for documentation"></i>
                Ignored Patterns
              </label>
              <div class="field-input">
                <!-- Mobile-friendly autocomplete -->
                <app-mobile-autocomplete
                  formControlName="ignoredPatterns"
                  placeholder="Add pattern"
                ></app-mobile-autocomplete>
                
                <!-- Desktop autocomplete -->
                <p-autocomplete
                  formControlName="ignoredPatterns"
                  multiple
                  fluid
                  [typeahead]="false"
                  placeholder="Add pattern and press Enter"
                  class="desktop-only"
                >
                </p-autocomplete>
                <small class="form-helper-text"
                  >Failed imports containing these patterns will be skipped (e.g. <code>sample</code>)</small
                >
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Stalled Settings -->
        <p-accordion-panel [disabled]="!queueCleanerForm.get('enabled')?.value" [value]="1">
          <p-accordion-header>
            <ng-template #toggleicon let-active="active">
              @if (active) {
                <i class="pi pi-chevron-up"></i>
              } @else {
                <i class="pi pi-chevron-down"></i>
              }
            </ng-template>
            Stalled Download Settings
          </p-accordion-header>
          <p-accordion-content>
            <div class="field-row" formGroupName="stalled">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('stalled.maxStrikes')" 
                   title="Click for documentation"></i>
                Max Strikes
              </label>
              <div>
                <div class="field-input">
                  <p-inputNumber
                    formControlName="maxStrikes"
                    [showButtons]="true"
                    [min]="0"
                    buttonLayout="horizontal"
                  >
                  </p-inputNumber>
                </div>
                <small *ngIf="hasNestedError('stalled', 'maxStrikes', 'required')" class="p-error">This field is required</small>
                <small *ngIf="hasNestedError('stalled', 'maxStrikes', 'max')" class="p-error">Value cannot exceed 5000</small>
                <small class="form-helper-text"
                  >Number of strikes before action is taken (0 to disable, min 3 to enable)</small
                >
              </div>
            </div>

            <div class="field-row" formGroupName="stalled">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('stalled.resetStrikesOnProgress')" 
                   title="Click for documentation"></i>
                Reset Strikes On Progress
              </label>
              <div class="field-input">
                <p-checkbox formControlName="resetStrikesOnProgress" [binary]="true"></p-checkbox>
                <small class="form-helper-text">When enabled, strikes will be reset if download progress is made</small>
              </div>
            </div>

            <div class="field-row" formGroupName="stalled">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('stalled.ignorePrivate')" 
                   title="Click for documentation"></i>
                Ignore Private
              </label>
              <div class="field-input">
                <p-checkbox formControlName="ignorePrivate" [binary]="true"></p-checkbox>
                <small class="form-helper-text">When enabled, private torrents will not be checked for being stalled</small>
              </div>
            </div>

            <div class="field-row" formGroupName="stalled">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('stalled.deletePrivate')" 
                   title="Click for documentation"></i>
                Delete Private
              </label>
              <div class="field-input">
                <p-checkbox formControlName="deletePrivate" [binary]="true"></p-checkbox>
                <small class="form-helper-text">Disable this if you want to keep private torrents in the download client even if they are removed from the arrs</small>
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Downloading Metadata Settings -->
        <p-accordion-panel [disabled]="!queueCleanerForm.get('enabled')?.value" [value]="2">
          <p-accordion-header>
            <ng-template #toggleicon let-active="active">
              @if (active) {
                <i class="pi pi-chevron-up"></i>
              } @else {
                <i class="pi pi-chevron-down"></i>
              }
            </ng-template>
            Downloading Metadata Settings (qBittorrent only)
          </p-accordion-header>
          <p-accordion-content>
            <div class="field-row" formGroupName="stalled">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('stalled.downloadingMetadataMaxStrikes')" 
                   title="Click for documentation"></i>
                Max Strikes for Downloading Metadata
              </label>
              <div>
                <div class="field-input">
                  <p-inputNumber
                    formControlName="downloadingMetadataMaxStrikes"
                    [showButtons]="true"
                    [min]="0"
                    buttonLayout="horizontal"
                  >
                  </p-inputNumber>
                </div>
                <small *ngIf="hasNestedError('stalled', 'downloadingMetadataMaxStrikes', 'required')" class="p-error">This field is required</small>
                <small *ngIf="hasNestedError('stalled', 'downloadingMetadataMaxStrikes', 'max')" class="p-error">Value cannot exceed 5000</small>
                <small class="form-helper-text"
                  >Number of strikes before action is taken (0 to disable, min 3 to enable)</small
                >
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Slow Download Settings -->
        <p-accordion-panel [disabled]="!queueCleanerForm.get('enabled')?.value" [value]="3">
          <p-accordion-header>
            <ng-template #toggleicon let-active="active">
              @if (active) {
                <i class="pi pi-chevron-up"></i>
              } @else {
                <i class="pi pi-chevron-down"></i>
              }
            </ng-template>
            Slow Download Settings
          </p-accordion-header>
          <p-accordion-content>
            <div class="field-row" formGroupName="slow">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('slow.maxStrikes')" 
                   title="Click for documentation"></i>
                Max Strikes
              </label>
              <div>
                <div class="field-input">
                  <p-inputNumber
                    formControlName="maxStrikes"
                    [showButtons]="true"
                    [min]="0"
                    buttonLayout="horizontal"
                  >
                  </p-inputNumber>
                </div>
                <small *ngIf="hasNestedError('slow', 'maxStrikes', 'required')" class="p-error">This field is required</small>
                <small *ngIf="hasNestedError('slow', 'maxStrikes', 'max')" class="p-error">Value cannot exceed 5000</small>
                <small class="form-helper-text"
                  >Number of strikes before action is taken (0 to disable, min 3 to enable)</small
                >
              </div>
            </div>

            <div class="field-row" formGroupName="slow">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('slow.resetStrikesOnProgress')" 
                   title="Click for documentation"></i>
                Reset Strikes On Progress
              </label>
              <div class="field-input">
                <p-checkbox formControlName="resetStrikesOnProgress" [binary]="true"></p-checkbox>
                <small class="form-helper-text">When enabled, strikes will be reset if download progress is made</small>
              </div>
            </div>

            <div class="field-row" formGroupName="slow">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('slow.ignorePrivate')" 
                   title="Click for documentation"></i>
                Ignore Private
              </label>
              <div class="field-input">
                <p-checkbox formControlName="ignorePrivate" [binary]="true"></p-checkbox>
                <small class="form-helper-text">When enabled, private torrents will not be checked for being slow</small>
              </div>
            </div>

            <div class="field-row" formGroupName="slow">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('slow.deletePrivate')" 
                   title="Click for documentation"></i>
                Delete Private
              </label>
              <div class="field-input">
                <p-checkbox formControlName="deletePrivate" [binary]="true"></p-checkbox>
                <small class="form-helper-text">Disable this if you want to keep private torrents in the download client even if they are removed from the arrs</small>
              </div>
            </div>

            <div class="field-row" formGroupName="slow">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('slow.minSpeed')" 
                   title="Click for documentation"></i>
                Minimum Speed
              </label>
              <div class="field-input">
                <app-byte-size-input
                  formControlName="minSpeed"
                  [min]="0"
                  placeholder="Enter minimum speed"
                  helpText="Minimum speed threshold for slow downloads (e.g., 100KB/s)"
                  type="speed"
                >
                </app-byte-size-input>
              </div>
            </div>

            <div class="field-row" formGroupName="slow">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('slow.maxTime')" 
                   title="Click for documentation"></i>
                Maximum Time (hours)
              </label>
              <div>
                <div class="field-input">
                  <p-inputNumber
                    formControlName="maxTime"
                    [showButtons]="true"
                    [min]="0"
                    buttonLayout="horizontal"
                  >
                  </p-inputNumber>
                </div>
                <small *ngIf="hasNestedError('slow', 'maxTime', 'required')" class="p-error">This field is required</small>
                <small *ngIf="hasNestedError('slow', 'maxTime', 'max')" class="p-error">Value cannot exceed 1000</small>
                <small class="form-helper-text">Maximum time allowed for slow downloads (0 means disabled)</small>
              </div>
            </div>

            <div class="field-row" formGroupName="slow">
              <label class="field-label">
                <i class="pi pi-question-circle field-info-icon" 
                   (click)="openFieldDocs('slow.ignoreAboveSize')" 
                   title="Click for documentation"></i>
                Ignore Above Size
              </label>
              <div class="field-input">
                <app-byte-size-input
                  formControlName="ignoreAboveSize"
                  [min]="0"
                  placeholder="Enter size threshold"
                  helpText="Downloads will be ignored if size exceeds, e.g., 25 GB"
                  type="size"
                >
                </app-byte-size-input>
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Stall Rules Management -->
        <p-accordion-panel [disabled]="!queueCleanerForm.get('enabled')?.value" [value]="4">
          <p-accordion-header>
            <ng-template #toggleicon let-active="active">
              @if (active) {
                <i class="pi pi-chevron-up"></i>
              } @else {
                <i class="pi pi-chevron-down"></i>
              }
            </ng-template>
            Stalled Download Rules
          </p-accordion-header>
          <p-accordion-content>
            <!-- Coverage Analysis Warning -->
            <div *ngIf="stallRulesCoverage.hasGaps" class="coverage-info mb-3 p-3 border-1 surface-border border-round">
              <div class="flex align-items-start gap-2">
                <i class="pi pi-exclamation-triangle text-orange-500 mt-1"></i>
                <div>
                  <h4 class="m-0 mb-2 text-orange-700">Coverage Gaps Detected</h4>
                  <p class="m-0 mb-2 text-sm text-600">
                    Your stall rules don't cover all completion percentage ranges for all privacy types.
                    Torrents in uncovered ranges won't be processed by stall rules.
                  </p>
                  <div class="coverage-gaps">
                    <div *ngFor="let gap of stallRulesCoverage.gaps" class="gap-item text-sm">
                      <strong>{{ gap.privacyTypeLabel }} torrents:</strong> {{ gap.start }}% - {{ gap.end }}% completion not covered
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty state when no rules -->
            <div *ngIf="stallRulesCount === 0" class="empty-instances-message p-3 text-center">
              <i class="pi pi-pause empty-icon"></i>
              <p>No stalled download rules defined. Add a rule to customize stall detection.</p>
            </div>

            <!-- Rules List -->
            <div *ngIf="stallRulesCount > 0" class="instances-list">
              <div *ngFor="let rule of stallRules(); trackBy: trackStallRule" class="instance-item">
                <div class="instance-header">
                  <div class="instance-title">
                    <i class="pi pi-pause instance-icon"></i>
                    <span class="instance-name">{{ rule.name }}</span>
                  </div>
                  <div class="instance-actions">
                    <button 
                      pButton 
                      type="button" 
                      icon="pi pi-pencil" 
                      class="p-button-text p-button-sm"
                      [disabled]="queueCleanerSaving()"
                      (click)="editStallRule(rule)"
                      pTooltip="Edit rule"
                    ></button>
                    <button 
                      pButton 
                      type="button" 
                      icon="pi pi-trash" 
                      class="p-button-text p-button-sm p-button-danger"
                      [disabled]="queueCleanerSaving()"
                      (click)="deleteStallRule(rule)"
                      pTooltip="Delete rule"
                    ></button>
                  </div>
                </div>
                
                <div class="instance-content">
                  <div class="instance-field">
                    <label>Max Completion: {{ rule.maxCompletionPercentage }}%</label>
                  </div>
                  <div class="instance-field">
                    <label>Max Strikes: {{ rule.maxStrikes }}</label>
                  </div>
                  <div class="instance-field">
                    <label>Privacy Type: {{ rule.privacyType }}</label>
                  </div>
                  <div class="instance-field">
                    <label>Reset on Progress: 
                      <span [class]="rule.resetStrikesOnProgress ? 'text-green-500' : 'text-red-500'">
                        {{ rule.resetStrikesOnProgress ? 'Yes' : 'No' }}
                      </span>
                    </label>
                  </div>
                  <div class="instance-field">
                    <label>Status: 
                      <span [class]="rule.enabled ? 'text-green-500' : 'text-red-500'">
                        {{ rule.enabled ? 'Enabled' : 'Disabled' }}
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action buttons -->
            <div class="card-footer mt-3">
              <button 
                pButton 
                type="button" 
                icon="pi pi-plus" 
                label="Add Rule"
                class="p-button-outlined"
                [disabled]="queueCleanerForm.get('enabled')?.value === false"
                (click)="openStallRulesModal()"
              ></button>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Slow Rules Management -->
        <p-accordion-panel [disabled]="!queueCleanerForm.get('enabled')?.value" [value]="5">
          <p-accordion-header>
            <ng-template #toggleicon let-active="active">
              @if (active) {
                <i class="pi pi-chevron-up"></i>
              } @else {
                <i class="pi pi-chevron-down"></i>
              }
            </ng-template>
            Slow Download Rules
          </p-accordion-header>
          <p-accordion-content>
            <!-- Coverage Analysis Warning -->
            <div *ngIf="slowRulesCoverage.hasGaps" class="coverage-info mb-3 p-3 border-1 surface-border border-round">
              <div class="flex align-items-start gap-2">
                <i class="pi pi-exclamation-triangle text-orange-500 mt-1"></i>
                <div>
                  <h4 class="m-0 mb-2 text-orange-700">Coverage Gaps Detected</h4>
                  <p class="m-0 mb-2 text-sm text-600">
                    Your slow rules don't cover all completion percentage ranges for all privacy types.
                    Torrents in uncovered ranges won't be processed by slow rules.
                  </p>
                  <div class="coverage-gaps">
                    <div *ngFor="let gap of slowRulesCoverage.gaps" class="gap-item text-sm">
                      <strong>{{ gap.privacyTypeLabel }} torrents:</strong> {{ gap.start }}% - {{ gap.end }}% completion not covered
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty state when no rules -->
            <div *ngIf="slowRulesCount === 0" class="empty-instances-message p-3 text-center">
              <i class="pi pi-clock empty-icon"></i>
              <p>No slow download rules defined. Add a rule to customize slow download detection.</p>
            </div>

            <!-- Rules List -->
            <div *ngIf="slowRulesCount > 0" class="instances-list">
              <div *ngFor="let rule of slowRules(); trackBy: trackSlowRule" class="instance-item">
                <div class="instance-header">
                  <div class="instance-title">
                    <i class="pi pi-clock instance-icon"></i>
                    <span class="instance-name">{{ rule.name }}</span>
                  </div>
                  <div class="instance-actions">
                    <button 
                      pButton 
                      type="button" 
                      icon="pi pi-pencil" 
                      class="p-button-text p-button-sm"
                      [disabled]="queueCleanerSaving()"
                      (click)="editSlowRule(rule)"
                      pTooltip="Edit rule"
                    ></button>
                    <button 
                      pButton 
                      type="button" 
                      icon="pi pi-trash" 
                      class="p-button-text p-button-sm p-button-danger"
                      [disabled]="queueCleanerSaving()"
                      (click)="deleteSlowRule(rule)"
                      pTooltip="Delete rule"
                    ></button>
                  </div>
                </div>
                
                <div class="instance-content">
                  <div class="instance-field">
                    <label>Max Strikes: {{ rule.maxStrikes }}</label>
                  </div>
                  <div class="instance-field" *ngIf="rule.minSpeed">
                    <label>Min Speed: {{ rule.minSpeed }}</label>
                  </div>
                  <div class="instance-field" *ngIf="rule.maxTimeHours && rule.maxTimeHours > 0">
                    <label>Max Time: {{ rule.maxTimeHours }}h</label>
                  </div>
                  <div class="instance-field">
                    <label>Privacy Type: {{ rule.privacyType }}</label>
                  </div>
                  <div class="instance-field">
                    <label>Max Completion: {{ rule.maxCompletionPercentage }}%</label>
                  </div>
                  <div class="instance-field">
                    <label>Reset on Progress: 
                      <span [class]="rule.resetStrikesOnProgress ? 'text-green-500' : 'text-red-500'">
                        {{ rule.resetStrikesOnProgress ? 'Yes' : 'No' }}
                      </span>
                    </label>
                  </div>
                  <div class="instance-field" *ngIf="rule.ignoreAboveSize">
                    <label>Ignore Above Size: {{ rule.ignoreAboveSize }}</label>
                  </div>
                  <div class="instance-field">
                    <label>Status: 
                      <span [class]="rule.enabled ? 'text-green-500' : 'text-red-500'">
                        {{ rule.enabled ? 'Enabled' : 'Disabled' }}
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action buttons -->
            <div class="card-footer mt-3">
              <button 
                pButton 
                type="button" 
                icon="pi pi-plus" 
                label="Add Rule"
                class="p-button-outlined"
                [disabled]="queueCleanerForm.get('enabled')?.value === false"
                (click)="openSlowRulesModal()"
              ></button>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

      </p-accordion>

      <!-- Action buttons -->
      <div class="card-footer mt-3">
        <button
          pButton
          type="button"
          label="Save"
          icon="pi pi-save"
          class="p-button-primary"
          [disabled]="(!queueCleanerForm.dirty || !hasActualChanges) || queueCleanerForm.invalid || queueCleanerSaving()"
          [loading]="queueCleanerSaving()"
          (click)="saveQueueCleanerConfig()"
        ></button>
        <button
          pButton
          type="button"
          label="Reset"
          icon="pi pi-refresh"
          class="p-button-secondary p-button-outlined ml-2"
          (click)="resetQueueCleanerConfig()"
        ></button>
      </div>
    </form>
  </div>
</p-card>

</div>

<!-- Stall Rules Modal -->
<p-dialog 
  [(visible)]="stallRuleModalVisible" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="instance-modal"
  header="{{ editingStallRule ? 'Edit Stall Rule' : 'Add Stall Rule' }}"
  (onHide)="closeStallRuleModal()"
>
  <form [formGroup]="stallRuleForm" class="p-fluid instance-form">
    <div class="field">
      <label for="stall-rule-name">Name</label>
      <input 
        id="stall-rule-name"
        type="text" 
        pInputText 
        formControlName="name" 
        placeholder="My Stall Rule"
        class="w-full"
      />
      <small *ngIf="hasModalError(stallRuleForm, 'name', 'required')" class="p-error">Name is required</small>
      <small *ngIf="hasModalError(stallRuleForm, 'name', 'maxlength')" class="p-error">Name cannot exceed 100 characters</small>
    </div>

    <div class="field flex flex-row">
      <label class="field-label">Enabled</label>
      <div class="field-input">
        <p-checkbox formControlName="enabled" [binary]="true"></p-checkbox>
        <small class="form-helper-text">Enable this rule</small>
      </div>
    </div>

    <div class="field">
      <label for="stall-rule-strikes">Max Strikes</label>
      <p-inputNumber
        id="stall-rule-strikes"
        formControlName="maxStrikes"
        [showButtons]="true"
        buttonLayout="horizontal"
        class="w-full"
      ></p-inputNumber>
      <small *ngIf="hasModalError(stallRuleForm, 'maxStrikes', 'required')" class="p-error">Max strikes is required</small>
      <small *ngIf="hasModalError(stallRuleForm, 'maxStrikes', 'min')" class="p-error">Min value is 3</small>
      <small *ngIf="hasModalError(stallRuleForm, 'maxStrikes', 'max')" class="p-error">Max value is 5000</small>
      <small class="form-helper-text">Number of strikes before action is taken</small>
    </div>

    <div class="field">
      <label for="stall-rule-privacy-type">Privacy Type</label>
      <p-select
        id="stall-rule-privacy-type"
        formControlName="privacyType"
        [options]="privacyTypeOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Select privacy type"
        class="w-full"
      ></p-select>
      <small *ngIf="hasModalError(stallRuleForm, 'privacyType', 'required')" class="p-error">Privacy type is required</small>
      <small class="form-helper-text">Which torrent types this rule applies to</small>
    </div>

    <div class="field">
      <label for="stall-rule-max-completion">Max Completion Percentage</label>
      <p-inputNumber 
        id="stall-rule-max-completion"
        formControlName="maxCompletionPercentage"
        suffix="%"
        placeholder="Percentage"
        class="w-full"
      ></p-inputNumber>
      <small *ngIf="hasModalError(stallRuleForm, 'maxCompletionPercentage', 'min')" class="p-error">Percentage must be at least 1</small>
      <small *ngIf="hasModalError(stallRuleForm, 'maxCompletionPercentage', 'max')" class="p-error">Percentage cannot exceed 100</small>
      <small *ngIf="hasModalError(stallRuleForm, 'maxCompletionPercentage', 'required')" class="p-error">Percentage is required</small>
      <small class="form-helper-text">Apply the rule to torrents having the completion percentage less than or equal to this number</small>
    </div>

    <div class="field flex flex-row">
      <label class="field-label">Reset Strikes on Progress</label>
      <div class="field-input">
        <p-checkbox formControlName="resetStrikesOnProgress" [binary]="true"></p-checkbox>
        <small class="form-helper-text">Reset strike count when torrent shows progress</small>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="modal-footer">
      <button 
        pButton 
        type="button" 
        label="Cancel" 
        class="p-button-text"
        (click)="closeStallRuleModal()"
      ></button>
      <button 
        pButton 
        type="button" 
        label="{{ editingStallRule ? 'Update' : 'Save' }}" 
        icon="pi pi-save"
        class="p-button-primary ml-2"
        [disabled]="stallRuleForm.invalid || stallRuleSaving"
        [loading]="stallRuleSaving"
        (click)="saveStallRule()"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<!-- Slow Rules Modal -->
<p-dialog 
  [(visible)]="slowRuleModalVisible" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="instance-modal"
  header="{{ editingSlowRule ? 'Edit Slow Rule' : 'Add Slow Rule' }}"
  (onHide)="closeSlowRuleModal()"
>
  <form [formGroup]="slowRuleForm" class="p-fluid instance-form">
    <div class="field">
      <label for="slow-rule-name">Name</label>
      <input 
        id="slow-rule-name"
        type="text" 
        pInputText 
        formControlName="name" 
        placeholder="My Slow Rule"
        class="w-full"
      />
      <small *ngIf="hasModalError(slowRuleForm, 'name', 'required')" class="p-error">Name is required</small>
      <small *ngIf="hasModalError(slowRuleForm, 'name', 'maxlength')" class="p-error">Name cannot exceed 100 characters</small>
    </div>

    <div class="field flex flex-row">
      <label class="field-label">Enabled</label>
      <div class="field-input">
        <p-checkbox formControlName="enabled" [binary]="true"></p-checkbox>
        <small class="form-helper-text">Enable this rule</small>
      </div>
    </div>

    <div class="field">
      <label for="slow-rule-strikes">Max Strikes</label>
      <p-inputNumber
        id="slow-rule-strikes"
        formControlName="maxStrikes"
        [showButtons]="true"
        buttonLayout="horizontal"
        class="w-full"
      ></p-inputNumber>
      <small *ngIf="hasModalError(slowRuleForm, 'maxStrikes', 'required')" class="p-error">Max strikes is required</small>
      <small *ngIf="hasModalError(slowRuleForm, 'maxStrikes', 'min')" class="p-error">Min value is 3</small>
      <small *ngIf="hasModalError(slowRuleForm, 'maxStrikes', 'max')" class="p-error">Max value is 5000</small>
      <small class="form-helper-text">Number of strikes before action is taken</small>
    </div>

    <div class="field">
      <label for="slow-rule-speed">Min Speed</label>
      <app-byte-size-input
        formControlName="minSpeed"
        placeholder="Enter minimum speed"
        helpText="Minimum speed threshold for slow downloads (e.g., 100KB/s)"
        type="speed"
      >
      </app-byte-size-input>
      <small *ngIf="hasModalError(slowRuleForm, 'minSpeed', 'required')" class="p-error">Minimum speed is required</small>
    </div>

    <div class="field">
      <label for="slow-rule-max-time">Maximum Time (Hours)</label>
      <p-inputNumber
        formControlName="maxTimeHours"
        id="slow-rule-max-time"
        placeholder="Maximum download time in hours"
        [showButtons]="true"
        [step]="1"
        class="w-full"
      ></p-inputNumber>
      <small *ngIf="hasModalError(slowRuleForm, 'maxTimeHours', 'required')" class="p-error">Maximum time is required</small>
      <small *ngIf="hasModalError(slowRuleForm, 'maxTimeHours', 'min')" class="p-error">Min value is 0</small>
      <small class="form-helper-text">Maximum time allowed for slow downloads (0 means disabled)</small>
    </div>

    <div class="field">
      <label for="slow-rule-privacy-type">Privacy Type</label>
      <p-select
        id="slow-rule-privacy-type"
        formControlName="privacyType"
        [options]="privacyTypeOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Select privacy type"
        class="w-full"
      ></p-select>
      <small *ngIf="hasModalError(slowRuleForm, 'privacyType', 'required')" class="p-error">Privacy type is required</small>
      <small class="form-helper-text">Which torrent types this rule applies to</small>
    </div>

    <div class="field">
      <label for="slow-rule-max-completion">Max Completion %</label>
      <p-inputNumber
        formControlName="maxCompletionPercentage"
        id="slow-rule-max-completion"
        placeholder="Maximum completion percentage"
        [showButtons]="true"
        [step]="1"
        suffix="%"
        class="w-full"
      ></p-inputNumber>
      <small *ngIf="hasModalError(slowRuleForm, 'maxCompletionPercentage', 'min')" class="p-error">Percentage must be at least 1</small>
      <small *ngIf="hasModalError(slowRuleForm, 'maxCompletionPercentage', 'max')" class="p-error">Percentage cannot exceed 100</small>
      <small *ngIf="hasModalError(slowRuleForm, 'maxCompletionPercentage', 'required')" class="p-error">Percentage is required</small>
      <small class="form-helper-text">Leave empty to apply to all completion levels</small>
    </div>

    <div class="field">
      <label for="slow-rule-ignore-above-size">Ignore Above Size</label>
      <app-byte-size-input
        formControlName="ignoreAboveSize"
        [min]="0"
        placeholder="Enter size threshold"
        helpText="Downloads will be ignored if size exceeds, e.g., 25 GB"
        type="size"
      >
      </app-byte-size-input>
    </div>

    <div class="field flex flex-row">
      <label class="field-label">Reset Strikes on Progress</label>
      <div class="field-input">
        <p-checkbox formControlName="resetStrikesOnProgress" [binary]="true"></p-checkbox>
        <small class="form-helper-text">Reset strike count when torrent shows progress</small>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="modal-footer">
      <button 
        pButton 
        type="button" 
        label="Cancel" 
        class="p-button-text"
        (click)="closeSlowRuleModal()"
      ></button>
      <button 
        pButton 
        type="button" 
        label="{{ editingSlowRule ? 'Update' : 'Save' }}" 
        icon="pi pi-save"
        class="p-button-primary ml-2"
        [disabled]="slowRuleForm.invalid || slowRuleSaving"
        [loading]="slowRuleSaving"
        (click)="saveSlowRule()"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
