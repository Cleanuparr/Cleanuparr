<div class="settings-container">
  <div class="flex align-items-center justify-content-between mb-4">
    <h1>Notifications Configuration</h1>
  </div>

  <p-card styleClass="settings-card h-full">
    <ng-template pTemplate="header">
      <div class="flex align-items-center justify-content-between p-3 border-bottom-1 surface-border">
        <div class="header-title-container">
          <h2 class="card-title m-0">Notification Providers</h2>
          <span class="card-subtitle">Configure notification providers to receive alerts</span>
        </div>
      </div>
    </ng-template>

    <div class="card-content">
      <!-- Loading/Error Component -->
      <app-loading-error-state
        *ngIf="notificationProviderLoading() || notificationProviderError()"
        [loading]="notificationProviderLoading()"
        [error]="notificationProviderError()"
        loadingMessage="Loading notification providers..."
        errorMessage="Could not connect to server"
      ></app-loading-error-state>

      <!-- Providers List -->
      <div *ngIf="!notificationProviderLoading() && !notificationProviderError()" class="providers-list">
        <div 
          *ngFor="let provider of providers()" 
          class="provider-item p-3 border-round surface-border border-1 mb-3"
        >
          <div class="flex justify-content-between align-items-center">
            <div class="provider-info flex-1">
              <div class="flex align-items-center mb-2">
                <h4 class="m-0 mr-2">{{ provider.name }}</h4>
                <p-tag 
                  [value]="provider.type | titlecase" 
                  [severity]="'info'"
                  class="mr-2"
                ></p-tag>
                <p-tag 
                  [value]="provider.isEnabled ? 'Enabled' : 'Disabled'" 
                  [severity]="provider.isEnabled ? 'success' : 'secondary'"
                ></p-tag>
              </div>
              <div class="provider-events text-sm text-color-secondary">
                <span *ngIf="provider.events.onFailedImportStrike" class="mr-2">‚ùå Failed Import</span>
                <span *ngIf="provider.events.onStalledStrike" class="mr-2">‚è∏Ô∏è Stalled</span>
                <span *ngIf="provider.events.onSlowStrike" class="mr-2">üêå Slow</span>
                <span *ngIf="provider.events.onQueueItemDeleted" class="mr-2">üóëÔ∏è Queue Deleted</span>
                <span *ngIf="provider.events.onDownloadCleaned" class="mr-2">üßπ Download Cleaned</span>
                <span *ngIf="provider.events.onCategoryChanged" class="mr-2">ÔøΩ Category Changed</span>
              </div>
            </div>
            <div class="provider-actions">
              <button 
                pButton 
                type="button" 
                icon="pi pi-play" 
                class="p-button-rounded p-button-text p-button-sm mr-1"
                pTooltip="Test notification"
                [loading]="testing()"
                (click)="testProvider(provider)"
              ></button>
              <button 
                pButton 
                type="button" 
                icon="pi pi-pencil" 
                class="p-button-rounded p-button-text p-button-sm mr-1"
                pTooltip="Edit provider"
                [disabled]="saving()"
                (click)="openEditProviderModal(provider)"
              ></button>
              <button 
                pButton 
                type="button" 
                icon="pi pi-trash" 
                class="p-button-rounded p-button-text p-button-danger p-button-sm"
                pTooltip="Delete provider"
                [disabled]="saving()"
                (click)="deleteProvider(provider)"
              ></button>
            </div>
          </div>
        </div>

        <div 
          *ngIf="providers().length === 0" 
          class="no-providers text-center py-5 text-color-secondary"
        >
          <i class="pi pi-bell text-4xl mb-3"></i>
          <p class="m-0">No notification providers configured</p>
          <small>Add a provider to start receiving notifications</small>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="card-footer mt-3">
        <button 
          pButton 
          type="button" 
          icon="pi pi-plus" 
          label="Add Provider"
          class="p-button-primary"
          [disabled]="saving()"
          (click)="openAddProviderModal()"
        ></button>
      </div>
    </div>
  </p-card>
</div>

<!-- Legacy Provider Modal (for unsupported provider types) -->
<p-dialog 
  [(visible)]="showProviderModal" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="instance-modal"
  [header]="modalTitle"
  (onHide)="closeProviderModal()"
>
  <div class="text-center py-4">
    <i class="pi pi-info-circle text-4xl mb-3 text-color-secondary"></i>
    <h3>Provider Type Not Yet Supported</h3>
    <p class="text-color-secondary">
      This provider type is not yet supported by the new modal system.
      <br>Please select Notifiarr or Apprise for now.
    </p>
    <button 
      pButton 
      type="button" 
      label="Close" 
      class="p-button-text mt-3"
      (click)="closeProviderModal()"
    ></button>
  </div>
</p-dialog>

<!-- Provider Type Selection Modal -->
<app-provider-type-selection
  [visible]="showTypeSelectionModal"
  (providerSelected)="onProviderTypeSelected($event)"
  (cancel)="onTypeSelectionCancel()"
></app-provider-type-selection>

<!-- Notifiarr Provider Modal -->
<app-notifiarr-provider
  [visible]="showNotifiarrModal"
  [editingProvider]="editingProvider"
  [saving]="saving()"
  [testing]="testing()"
  (save)="onNotifiarrSave($event)"
  (cancel)="onProviderCancel()"
  (test)="onNotifiarrTest($event)"
></app-notifiarr-provider>

<!-- Apprise Provider Modal -->
<app-apprise-provider
  [visible]="showAppriseModal"
  [editingProvider]="editingProvider"
  [saving]="saving()"
  [testing]="testing()"
  (save)="onAppriseSave($event)"
  (cancel)="onProviderCancel()"
  (test)="onAppriseTest($event)"
></app-apprise-provider>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>

<!-- Toast for notifications -->
<p-toast></p-toast>
