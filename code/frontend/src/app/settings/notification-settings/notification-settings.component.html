<div class="settings-layout">
  <div class="settings-content">
    <p-card header="Notification Providers" styleClass="settings-card">
      <div class="providers-list">
        <div 
          *ngFor="let provider of providers()" 
          class="provider-item p-3 border-round surface-border border-1 mb-3"
        >
          <div class="flex justify-content-between align-items-center">
            <div class="provider-info flex-1">
              <div class="flex align-items-center mb-2">
                <h4 class="m-0 mr-2">{{ provider.name }}</h4>
                <p-tag 
                  [value]="provider.type | titlecase" 
                  [severity]="'info'"
                  class="mr-2"
                ></p-tag>
                <p-tag 
                  [value]="provider.isEnabled ? 'Enabled' : 'Disabled'" 
                  [severity]="provider.isEnabled ? 'success' : 'secondary'"
                ></p-tag>
              </div>
              <div class="provider-events text-sm text-color-secondary">
                <span *ngIf="provider.events.onFailedImportStrike" class="mr-2">‚ùå Failed Import</span>
                <span *ngIf="provider.events.onStalledStrike" class="mr-2">‚è∏Ô∏è Stalled</span>
                <span *ngIf="provider.events.onSlowStrike" class="mr-2">üêå Slow</span>
                <span *ngIf="provider.events.onQueueItemDeleted" class="mr-2">üóëÔ∏è Queue Deleted</span>
                <span *ngIf="provider.events.onDownloadCleaned" class="mr-2">üßπ Download Cleaned</span>
                <span *ngIf="provider.events.onCategoryChanged" class="mr-2">ÔøΩ Category Changed</span>
              </div>
            </div>
            <div class="provider-actions">
              <button 
                pButton 
                type="button" 
                icon="pi pi-play" 
                class="p-button-rounded p-button-text p-button-sm mr-1"
                pTooltip="Test notification"
                [loading]="testing()"
                (click)="testProvider(provider)"
              ></button>
              <button 
                pButton 
                type="button" 
                icon="pi pi-pencil" 
                class="p-button-rounded p-button-text p-button-sm mr-1"
                pTooltip="Edit provider"
                [disabled]="saving()"
                (click)="openEditProviderModal(provider)"
              ></button>
              <button 
                pButton 
                type="button" 
                icon="pi pi-trash" 
                class="p-button-rounded p-button-text p-button-danger p-button-sm"
                pTooltip="Delete provider"
                [disabled]="saving()"
                (click)="deleteProvider(provider)"
              ></button>
            </div>
          </div>
        </div>

        <div 
          *ngIf="providers().length === 0" 
          class="no-providers text-center py-5 text-color-secondary"
        >
          <i class="pi pi-bell text-4xl mb-3"></i>
          <p class="m-0">No notification providers configured</p>
          <small>Add a provider to start receiving notifications</small>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="card-footer mt-3">
        <button 
          pButton 
          type="button" 
          icon="pi pi-plus" 
          label="Add Provider"
          class="p-button-outlined"
          [disabled]="saving()"
          (click)="openAddProviderModal()"
        ></button>
      </div>
    </p-card>
  </div>
</div>

<!-- Provider Modal -->
<p-dialog 
  [(visible)]="showProviderModal" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="instance-modal"
  [header]="modalTitle"
  (onHide)="closeProviderModal()"
>
  <form [formGroup]="providerForm" class="p-fluid instance-form">
    <div class="field flex flex-row">
      <label class="field-label">
        <i class="pi pi-question-circle field-info-icon" 
           pTooltip="Enable this notification provider"></i>
        Enabled
      </label>
      <div class="field-input">
        <p-checkbox formControlName="enabled" [binary]="true"></p-checkbox>
        <small class="form-helper-text">Enable this notification provider</small>
      </div>
    </div>

    <div class="field">
      <label for="provider-name">
        <i class="pi pi-question-circle field-info-icon" 
           pTooltip="Name for this notification provider"></i>
        Name *
      </label>
      <input 
        id="provider-name"
        type="text" 
        pInputText 
        formControlName="name" 
        placeholder="My Notification Provider"
        class="w-full"
      />
      <small *ngIf="hasError(providerForm, 'name', 'required')" class="p-error">Name is required</small>
    </div>

    <div class="field">
      <label for="provider-type">
        <i class="pi pi-question-circle field-info-icon" 
           pTooltip="Type of notification provider"></i>
        Provider Type *
      </label>
      <p-select
        id="provider-type"
        formControlName="type"
        [options]="typeOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Select provider type"
        appendTo="body"
        class="w-full"
        (onChange)="onTypeChange($event)"
      ></p-select>
      <small *ngIf="hasError(providerForm, 'type', 'required')" class="p-error">Provider type is required</small>
    </div>

    <!-- Events Section -->
    <div class="field">
      <label class="mb-3">
        <i class="pi pi-question-circle field-info-icon" 
           pTooltip="Select which events trigger notifications"></i>
        Notification Events
      </label>
      <div class="grid">
        <div class="col-6">
          <div class="field-checkbox">
            <p-checkbox formControlName="onFailedImportStrike" [binary]="true" inputId="on-failed-import-strike"></p-checkbox>
            <label for="on-failed-import-strike" class="ml-2">On Failed Import Strike</label>
          </div>
        </div>
        <div class="col-6">
          <div class="field-checkbox">
            <p-checkbox formControlName="onStalledStrike" [binary]="true" inputId="on-stalled-strike"></p-checkbox>
            <label for="on-stalled-strike" class="ml-2">On Stalled Strike</label>
          </div>
        </div>
        <div class="col-6">
          <div class="field-checkbox">
            <p-checkbox formControlName="onSlowStrike" [binary]="true" inputId="on-slow-strike"></p-checkbox>
            <label for="on-slow-strike" class="ml-2">On Slow Strike</label>
          </div>
        </div>
        <div class="col-6">
          <div class="field-checkbox">
            <p-checkbox formControlName="onQueueItemDeleted" [binary]="true" inputId="on-queue-item-deleted"></p-checkbox>
            <label for="on-queue-item-deleted" class="ml-2">On Queue Item Deleted</label>
          </div>
        </div>
        <div class="col-6">
          <div class="field-checkbox">
            <p-checkbox formControlName="onDownloadCleaned" [binary]="true" inputId="on-download-cleaned"></p-checkbox>
            <label for="on-download-cleaned" class="ml-2">On Download Cleaned</label>
          </div>
        </div>
        <div class="col-6">
          <div class="field-checkbox">
            <p-checkbox formControlName="onCategoryChanged" [binary]="true" inputId="on-category-changed"></p-checkbox>
            <label for="on-category-changed" class="ml-2">On Category Changed</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Provider-specific configuration will be added here based on type -->
    <ng-container [ngSwitch]="providerForm.get('type')?.value">
      <!-- Discord Configuration -->
      <ng-container *ngSwitchCase="'Discord'">
        <div class="field">
          <label for="discord-webhook-url">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="Discord webhook URL"></i>
            Webhook URL *
          </label>
          <input 
            id="discord-webhook-url"
            type="text" 
            pInputText 
            formControlName="webhookUrl" 
            placeholder="https://discord.com/api/webhooks/..."
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'webhookUrl', 'required')" class="p-error">Webhook URL is required</small>
        </div>
      </ng-container>

      <!-- Slack Configuration -->
      <ng-container *ngSwitchCase="'Slack'">
        <div class="field">
          <label for="slack-webhook-url">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="Slack webhook URL"></i>
            Webhook URL *
          </label>
          <input 
            id="slack-webhook-url"
            type="text" 
            pInputText 
            formControlName="webhookUrl" 
            placeholder="https://hooks.slack.com/services/..."
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'webhookUrl', 'required')" class="p-error">Webhook URL is required</small>
        </div>
      </ng-container>

      <!-- Email Configuration -->
      <ng-container *ngSwitchCase="'Email'">
        <div class="field">
          <label for="email-server">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="SMTP server address"></i>
            SMTP Server *
          </label>
          <input 
            id="email-server"
            type="text" 
            pInputText 
            formControlName="server" 
            placeholder="smtp.gmail.com"
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'server', 'required')" class="p-error">SMTP server is required</small>
        </div>

        <div class="field">
          <label for="email-port">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="SMTP server port"></i>
            Port *
          </label>
          <input 
            id="email-port"
            type="number" 
            pInputText 
            formControlName="port" 
            placeholder="587"
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'port', 'required')" class="p-error">Port is required</small>
        </div>

        <div class="field">
          <label for="email-username">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="SMTP username"></i>
            Username *
          </label>
          <input 
            id="email-username"
            type="text" 
            pInputText 
            formControlName="username" 
            placeholder="your-email@gmail.com"
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'username', 'required')" class="p-error">Username is required</small>
        </div>

        <div class="field">
          <label for="email-password">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="SMTP password"></i>
            Password *
          </label>
          <input 
            id="email-password"
            type="password" 
            pInputText 
            formControlName="password" 
            placeholder="Password"
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'password', 'required')" class="p-error">Password is required</small>
        </div>

        <div class="field">
          <label for="email-from">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="From email address"></i>
            From Email *
          </label>
          <input 
            id="email-from"
            type="email" 
            pInputText 
            formControlName="fromEmail" 
            placeholder="notifications@yourdomain.com"
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'fromEmail', 'required')" class="p-error">From email is required</small>
        </div>

        <div class="field">
          <label for="email-to">
            <i class="pi pi-question-circle field-info-icon" 
               pTooltip="To email address"></i>
            To Email *
          </label>
          <input 
            id="email-to"
            type="email" 
            pInputText 
            formControlName="toEmail" 
            placeholder="admin@yourdomain.com"
            class="w-full"
          />
          <small *ngIf="hasError(providerForm, 'toEmail', 'required')" class="p-error">To email is required</small>
        </div>
      </ng-container>
    </ng-container>
  </form>

  <ng-template pTemplate="footer">
    <div class="modal-footer">
      <button 
        pButton 
        type="button" 
        label="Cancel" 
        class="p-button-text"
        (click)="closeProviderModal()"
      ></button>
      <button 
        pButton 
        type="button" 
        label="Test" 
        icon="pi pi-play"
        class="p-button-outlined ml-2"
        [disabled]="providerForm.invalid || testing() || saving()"
        [loading]="testing()"
        (click)="testCurrentProvider()"
        *ngIf="isEditing"
      ></button>
      <button 
        pButton 
        type="button" 
        label="Save" 
        icon="pi pi-save"
        class="p-button-primary ml-2"
        [disabled]="providerForm.invalid || saving()"
        [loading]="saving()"
        (click)="saveProvider()"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>

<!-- Toast for notifications -->
<p-toast></p-toast>
