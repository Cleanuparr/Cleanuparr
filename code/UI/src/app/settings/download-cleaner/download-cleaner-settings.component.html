<!-- Toast notifications handled by central toast container -->

<p-card styleClass="settings-card h-full">
  <ng-template pTemplate="header">
    <div class="flex align-items-center justify-content-between p-3 border-bottom-1 surface-border">
      <div class="header-title-container">
        <h2 class="card-title m-0">Download Cleaner Configuration</h2>
        <span class="card-subtitle">Configure automatic download cleanup</span>
      </div>
      <div class="flex align-items-center gap-2">
        <i class="pi pi-cog text-xl"></i>
      </div>
    </div>
  </ng-template>

  <div class="card-content">
    <!-- Loading/Error State Component -->
    <app-loading-error-state
      *ngIf="downloadCleanerLoading() || downloadCleanerError()"
      [loading]="downloadCleanerLoading()"
      [error]="downloadCleanerError()"
      loadingMessage="Loading settings..."
      errorMessage="Could not connect to server"
    ></app-loading-error-state>

    <!-- Form Content - only shown when not loading and no error -->
    <form *ngIf="!downloadCleanerLoading() && !downloadCleanerError()" [formGroup]="downloadCleanerForm" class="p-fluid">
      <!-- Main Settings -->
      <div class="field-row">
        <label class="field-label">Enable Download Cleaner</label>
        <div class="field-input">
          <p-checkbox formControlName="enabled" [binary]="true" inputId="dcEnabled"></p-checkbox>
          <small class="form-helper-text">When enabled, the download cleaner will run according to the schedule</small>
        </div>
      </div>

      <!-- Scheduling Mode Toggle -->
      <div class="field-row">
        <label class="field-label">Scheduling Mode</label>
        <div class="field-input">
          <p-selectButton
            formControlName="useAdvancedScheduling"
            [options]="scheduleModeOptions"
            optionLabel="label"
            optionValue="value"
          >
          </p-selectButton>
          <small class="form-helper-text">Choose between basic scheduling or advanced cron expression</small>
        </div>
      </div>

      <!-- Basic Schedule Controls - shown when useAdvancedScheduling is false -->
      <div class="field-row" formGroupName="jobSchedule" *ngIf="!downloadCleanerForm.get('useAdvancedScheduling')?.value">
        <label class="field-label">Run Schedule</label>
        <div>
          <div class="field-input schedule-input flex flex-wrap">
            <span class="schedule-label">Every</span>
            <p-select 
              formControlName="every"
              [options]="getScheduleValueOptions()"
              optionLabel="label"
              optionValue="value"
              placeholder="Select interval"
            ></p-select>

            <p-selectButton
              formControlName="type"
              [options]="scheduleUnitOptions"
              optionLabel="label"
              optionValue="value"
            >
            </p-selectButton>
          </div>
          <small *ngIf="hasNestedError('jobSchedule', 'every', 'required')" class="p-error">This field is required</small>
          <small class="form-helper-text">How often the download cleaner should run</small>
        </div>
      </div>

      <!-- Advanced Schedule Controls - shown when useAdvancedScheduling is true -->
      <div class="field-row" *ngIf="downloadCleanerForm.get('useAdvancedScheduling')?.value">
        <label class="field-label">Cron Expression</label>
        <div>
          <div class="field-input">
            <input type="text" pInputText formControlName="cronExpression" placeholder="0 0/5 * ? * * *" />
          </div>
          <small *ngIf="downloadCleanerForm.get('cronExpression')?.hasError('required') && downloadCleanerForm.get('cronExpression')?.touched" class="p-error">Cron expression is required</small>
          <small class="form-helper-text">Enter a valid Quartz cron expression (e.g., "0 0/5 * ? * * *" runs every 5 minutes)</small>
        </div>
      </div>

      <!-- Delete Private Option -->
      <div class="field-row">
        <label class="field-label">Delete Private Torrents</label>
        <div class="field-input">
          <p-checkbox formControlName="deletePrivate" [binary]="true" inputId="deletePrivate"></p-checkbox>
          <small class="form-helper-text">When enabled, private torrents will be deleted</small>
        </div>
      </div>

      <!-- Categories Management -->
      <div class="section-header mt-4 mb-2">
        <h3>Clean Categories</h3>
        <small>Configure categories for automatic cleanup</small>
      </div>

      <!-- Categories Table -->
      <div class="categories-container mb-3">
        <p-table [value]="categoriesFormArray.controls" [responsive]="true" styleClass="p-datatable-sm">
          <ng-template pTemplate="header">
            <tr>
              <th>Category Name</th>
              <th>Delete After (Days)</th>
              <th>Min Size</th>
              <th>Max Size</th>
              <th>Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-category let-i="rowIndex">
            <tr [formGroup]="category">
              <td>
                <input type="text" pInputText formControlName="name" placeholder="Category name" />
                <small *ngIf="hasCategoryError(i, 'name', 'required')" class="p-error block">Name is required</small>
              </td>
              <td>
                <p-inputNumber formControlName="deleteAfterDays" [min]="1" [showButtons]="true" buttonLayout="horizontal"></p-inputNumber>
                <small *ngIf="hasCategoryError(i, 'deleteAfterDays', 'required')" class="p-error block">Required</small>
                <small *ngIf="hasCategoryError(i, 'deleteAfterDays', 'min')" class="p-error block">Min value is 1</small>
              </td>
              <td>
                <app-byte-size-input formControlName="minimumSizeBytes"></app-byte-size-input>
              </td>
              <td>
                <app-byte-size-input formControlName="maximumSizeBytes"></app-byte-size-input>
              </td>
              <td>
                <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-sm" 
                  (click)="removeCategory(i)" [disabled]="downloadCleanerForm.disabled"></button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center p-3">
                No categories defined. Add a category to start cleaning downloads.
              </td>
            </tr>
          </ng-template>
        </p-table>
        
        <div class="mt-2">
          <button pButton type="button" label="Add Category" icon="pi pi-plus" 
            (click)="addCategory()" [disabled]="downloadCleanerForm.disabled"></button>
        </div>
      </div>

      <!-- Unlinked Downloads Settings -->
      <div class="section-header mt-4 mb-2">
        <h3>Unlinked Downloads Settings</h3>
        <small>Configure handling of unlinked downloads</small>
      </div>

      <!-- Unlinked Target Category -->
      <div class="field-row">
        <label class="field-label">Target Category</label>
        <div>
          <div class="field-input">
            <input type="text" pInputText formControlName="unlinkedTargetCategory" placeholder="Target category name" />
          </div>
          <small *ngIf="hasError('unlinkedTargetCategory', 'required')" class="p-error">Target category is required</small>
          <small class="form-helper-text">Category to move unlinked downloads to</small>
        </div>
      </div>

      <!-- Use Tag Option -->
      <div class="field-row">
        <label class="field-label">Use Tag</label>
        <div class="field-input">
          <p-checkbox formControlName="unlinkedUseTag" [binary]="true" inputId="unlinkedUseTag"></p-checkbox>
          <small class="form-helper-text">When enabled, uses a tag instead of category</small>
        </div>
      </div>

      <!-- Ignored Root Directory -->
      <div class="field-row">
        <label class="field-label">Ignored Root Directory</label>
        <div>
          <div class="field-input">
            <input type="text" pInputText formControlName="unlinkedIgnoredRootDir" placeholder="/path/to/directory" />
          </div>
          <small class="form-helper-text">Root directory to ignore when checking for unlinked downloads</small>
        </div>
      </div>

      <!-- Unlinked Categories -->
      <div class="field-row">
        <label class="field-label">Unlinked Categories</label>
        <div>
          <div class="field-input">
            <p-autocomplete
              formControlName="unlinkedCategories"
              multiple
              fluid
              [typeahead]="false"
              placeholder="Add category and press Enter"
            >
            </p-autocomplete>
          </div>
          <small class="form-helper-text">Categories to check for unlinked downloads</small>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions mt-4 flex justify-content-end gap-2">
        <button 
          pButton 
          type="button" 
          label="Reset" 
          class="p-button-outlined" 
          (click)="resetDownloadCleanerConfig()"
          [disabled]="downloadCleanerSaving()"
        ></button>
        <button 
          pButton 
          type="submit" 
          label="Save" 
          icon="pi pi-save" 
          (click)="saveDownloadCleanerConfig()"
          [disabled]="!downloadCleanerForm.dirty || downloadCleanerSaving()"
          [loading]="downloadCleanerSaving()"
        ></button>
      </div>
    </form>
  </div>
</p-card>
