<p-card styleClass="settings-card h-full">
  <ng-template pTemplate="header">
    <div class="flex align-items-center justify-content-between p-3 border-bottom-1 surface-border">
      <div class="header-title-container">
        <h2 class="card-title m-0">Sonarr Configuration</h2>
        <span class="card-subtitle">Configure Sonarr integration settings</span>
      </div>
      <div class="flex align-items-center gap-2">
        <i class="pi pi-cog text-xl"></i>
      </div>
    </div>
  </ng-template>

  <div class="card-content">
    <!-- Loading/Error State Component -->
    <app-loading-error-state
      *ngIf="sonarrLoading() || sonarrError()"
      [loading]="sonarrLoading()"
      [error]="sonarrError()"
      loadingMessage="Loading settings..."
      errorMessage="Could not connect to server"
    ></app-loading-error-state>

    <!-- Form Content - only shown when not loading and no error -->
    <form *ngIf="!sonarrLoading() && !sonarrError()" [formGroup]="sonarrForm" class="p-fluid">
      <!-- Main Settings -->
      <div class="field-row">
        <label class="field-label">Enable Sonarr Integration</label>
        <div class="field-input">
          <p-checkbox formControlName="enabled" [binary]="true" inputId="sonarrEnabled"></p-checkbox>
          <small class="form-helper-text">When enabled, Sonarr API integration will be used</small>
        </div>
      </div>

      <div class="field-row">
        <label class="field-label">Failed Import Max Strikes</label>
        <div>
          <div class="field-input">
            <p-inputNumber
              formControlName="failedImportMaxStrikes"
              [min]="0" 
              [showButtons]="true"
              buttonLayout="horizontal"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              inputId="failedImportMaxStrikes"
            ></p-inputNumber>
          </div>
          <small class="form-helper-text">Maximum number of strikes before taking action (-1 to disable)</small>
        </div>
      </div>

      <div class="field-row">
        <label class="field-label">Search Type</label>
        <div>
          <div class="field-input">
            <p-dropdown
              formControlName="searchType"
              [options]="searchTypeOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Select search type"
              appendTo="body"
            ></p-dropdown>
          </div>
          <small *ngIf="hasError('searchType', 'required')" class="p-error">Search type is required</small>
          <small class="form-helper-text">Type of search used by Sonarr</small>
        </div>
      </div>

      <!-- Instances Section -->
      <div class="section-header mt-4">
        <h3>Sonarr Instances</h3>
        <small>Configure multiple Sonarr server instances</small>
      </div>

      <!-- Instances Container -->
      <div class="instances-container">
        <!-- Empty state message when no instances -->
        <div *ngIf="instances.controls.length === 0" class="empty-instances-message p-3 text-center">
          <p>No Sonarr instances defined. Add an instance to start using Sonarr integration.</p>
        </div>
        
        <!-- Instance cards -->
        <div class="instance-list">
          <div *ngFor="let instance of instances.controls; let i = index" class="instance-item" [formGroup]="getInstanceAsFormGroup(i)">
            <div class="instance-header">
              <div class="instance-title">
                <i class="pi pi-server instance-icon"></i>
                <input type="text" pInputText formControlName="name" placeholder="Instance name" class="instance-name-input" />
              </div>
              <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-sm" 
                (click)="removeInstance(i)" [disabled]="sonarrForm.disabled || !sonarrForm.get('enabled')?.value"></button>
            </div>
            <small *ngIf="hasInstanceFieldError(i, 'name', 'required')" class="p-error block">Name is required</small>
            
            <div class="instance-content">
              <div class="instance-field">
                <label>URL</label>
                <div class="field-input">
                  <input type="text" pInputText formControlName="url" placeholder="http://localhost:8989" required />
                  <small *ngIf="hasInstanceFieldError(i, 'url', 'required')" class="p-error block">URL is required</small>
                </div>
              </div>
              
              <div class="instance-field">
                <label>API Key</label>
                <div class="field-input">
                  <input type="password" pInputText formControlName="apiKey" placeholder="Your Sonarr API key" required />
                  <small *ngIf="hasInstanceFieldError(i, 'apiKey', 'required')" class="p-error block">API key is required</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex justify-content-end mt-3">
          <button pButton type="button" icon="pi pi-plus" label="Add Sonarr Instance" 
            (click)="addInstance()" [disabled]="!sonarrForm.get('enabled')?.value" class="p-button-success"></button>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="card-footer mt-3">
        <button
          pButton
          type="button"
          label="Save"
          icon="pi pi-save"
          class="p-button-outlined"
          [disabled]="(!sonarrForm.dirty || !hasActualChanges) || sonarrForm.invalid || sonarrSaving()"
          [loading]="sonarrSaving()"
          (click)="saveSonarrConfig()"
        ></button>
        <button
          pButton
          type="button"
          label="Reset"
          icon="pi pi-refresh"
          class="p-button-secondary p-button-outlined ml-2"
          (click)="resetSonarrConfig()"
        ></button>
      </div>
    </form>
  </div>
</p-card>
